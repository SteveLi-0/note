# Monte Carlo Tree Search for Behavior Planning in Autonomous Driving

## 摘要

将自动驾驶汽车引入城市和高速公路环境需要开发稳健且适应性强的行为规划和决策系统。本研究提出了一种基于蒙特卡洛树搜索（MCTS）的算法，旨在解决自动驾驶中的复杂挑战。我们的核心目标是利用MCTS在探索与利用之间的平衡，以实现复杂场景下的智能驾驶决策。

我们设计了一种专为自动驾驶需求而设的MCTS算法，结合了安全性、舒适性和效率等方面的成本函数，并将这些函数无缝整合进MCTS框架中。算法在仿真中表现出色，能够在现实场景中有效引导自动驾驶车辆，例如应对拥堵的交通状况，包括环岛通行、复杂交叉路口、动态的汇入/分流、无保护左转以及处理加塞与坡道等情况。

通过定性示例展示了该算法在多样化驾驶决策方面的能力，包括换道、加速和减速。此外，量化分析表明，该算法能够在不到1秒内提供纵向和横向决策结果，显示出实时在线规划的潜力。其在各种场景下的成功率进一步证明了算法的鲁棒性，表现出在复杂驾驶决策中的有效性与可靠性。

## 引言

自动驾驶技术的快速发展为超越传统范式的创新决策方法铺平了道路。在这一变革的核心，行为规划发挥着至关重要的作用，它是自动驾驶汽车复杂协同过程中的关键组成部分。行为规划战略性地决定车辆在纵向（如加速和减速）和横向（包括换道、调整位置和绕行）方向上的运动，以应对城市环境中复杂的环岛（图1-(a)）和繁忙交叉路口（图1-(b)）等场景。这一决策过程塑造了车辆对动态环境的响应，确保在这些场景下的安全性和效率。实现这一目标的关键在于开发高度智能化的决策系统，尤其是自动驾驶中的行为规划器。

在一个全面的自动驾驶系统中，多个组件协同工作，以精确地控制车辆的运动，包括用于环境感知的传感器、高精度地图用于定位、路径规划器用于导航、运动规划器用于生成轨迹、行为规划器用于决策，以及控制系统用于执行车辆动作。图2展示了自动驾驶的规划框架，该框架分为三个主要层级：任务规划器、行为规划器和运动规划器，每个层级负责不同规划范围和复杂度的任务。任务规划器确定长距离路线，运动规划器则微调短期轨迹。而本研究的核心重点是行为规划器，它汇总任务规划器提供的信息和即时上下文输入，做出换道、动态交互等决策，这对导航复杂场景至关重要。

本文强调行为规划器作为高层意图与低层控制动作之间的枢纽，协调车辆行为以同时满足目标和安全要求。为了提高仿真真实度，我们使用高斯白噪声模拟其他车辆的观察位置，引入反映真实传感器数据局限性的变化和不确定性。这种方法在面对驾驶条件的复杂性时，增强了我们行为规划方法的鲁棒性和适用性。

我们的核心方法是将蒙特卡洛树搜索（MCTS）算法[1]引入自动驾驶领域。MCTS起源于博弈论和人工智能，并在多个自主领域中得到应用，展示了其适应性和鲁棒性，例如定向问题[2]、传感任务分配[3]、持续监控[4][5]及自动驾驶[6]-[10]等。通过将MCTS应用于自动驾驶行为规划，我们利用其在探索与利用之间的固有平衡能力，使其非常适合处理现实交通场景中的复杂性、动态性和不确定性。该算法框架使行为规划器能够探索可能的动作序列，逐步收敛到最大化目标并符合安全约束的决策。

### **A. 相关工作**

在广阔的自动驾驶研究领域中，许多努力已针对自动驾驶行为规划中固有的挑战提出解决方案。其中值得注意的有**百度Apollo** [11]、**Autoware** [12] 以及基于这些平台的工作 [13]-[16]。这些开源自动驾驶平台涵盖了感知、定位、规划和控制等多个方面。Apollo 的行为规划模块通过集成**基于规则的决策**、**动态规划** 和 **二次规划** 生成驾驶行为策略。

基于**树搜索技术**的方法在自动驾驶中也被广泛探索。Karimi 等人 [10] 针对高速公路场景中的换道和汇流，提出了一种基于蒙特卡洛树搜索（MCTS）和**Level-K博弈论**的方法，以实现实时路径规划。与之相比，我们的工作更侧重于涵盖车辆行为运动的更广泛的行为规划，利用 MCTS 框架在复杂环境中探索多样化的驾驶决策。

Chen 等人 [9] 提出了**深度MCTS** 控制方法，用于基于视觉的自动驾驶。虽然这两篇论文均采用 MCTS，但我们的研究将 MCTS 作为一个全面的行为规划决策框架，集成了多种驾驶动作。Tian 等人 [6] 则利用 MCTS 提高了自动驾驶车辆反馈转向控制器的性能。总体来看，我们的研究更侧重于纵向与横向运动相结合的行为规划框架，适用于复杂的城市和高速公路场景。

### **B. 贡献**

我们的主要贡献如下：  

1. **引入了一种新颖的行为规划框架**，通过应用蒙特卡洛树搜索（MCTS）算法，提供了一种在复杂动态自动驾驶场景中导航的独特方法。  

2. **开发了多维度的成本函数**，其中涵盖了安全性、平滑性、效率和合理性等多个方面。这些成本函数引导MCTS算法，使其在决策过程中既保证安全性，又优化了效率。  

3. **通过在真实感的城市和高速公路场景中进行仿真**，我们评估了算法的性能。特别是在无保护左转和突发加塞等需要快速且安全决策的复杂场景中，该算法展现出了显著的效果。  

4. **通过定性结果展示算法的适应性**，并通过成功率和时间成本的量化评估，进一步证明了算法的高效性。在各种情况下，成功率接近100%，而时间成本保持在**1秒以内**，显示出其在实时应用中的潜力。  

总的来说，本文通过引入一种新的方法，将自动驾驶中的感知、导航、预测和运动控制进行有效衔接，特别是在**行为规划**部分。我们提出的方法通过综合成本函数进行优化，并在仿真中进行了全面评估。实验结果表明，该方法能够为自动驾驶汽车提供一种更智能、更具适应性且上下文感知的决策方案。  

### **II. 问题定义**

自动驾驶行为规划问题被重新定义为一个优化问题，目标是最小化车辆在预定时间范围内（如T秒）所产生的综合成本。该优化过程评估多个轨迹候选，重点考虑安全、高效导航所需的各个方面。总成本评估涵盖了四个主要维度：  

1. **安全性**，用于降低碰撞风险并确保车辆在安全边界内运行；  
2. **平滑性**，确保转弯和机动的过渡不会给乘客带来不适；  
3. **合理性**，确保车辆的行为合乎逻辑并能预测，以便与其他道路使用者互动；  
4. **效率**，优化旅行时间和速度。  

这些维度共同构成了我们方法的核心，引导自动驾驶车辆在决策时平衡安全、乘客舒适性和操作效率。

### **A. 目标函数**

更新后的目标函数根据安全性、平滑性、合理性和效率等标准，评估轨迹候选，表示为：

\[
J = \sum_{t=1}^{T} \left( \omega_s C_s(t) + \omega_m C_m(t) + \omega_r C_r(t) + \omega_e C_e(t) \right)
\]

其中，\( J \) 代表在时间区间 \( T \) 内需要最小化的总成本；\( C_s(t) \)、\( C_m(t) \)、\( C_r(t) \) 和 \( C_e(t) \) 分别表示时间 \( t \) 时刻的安全性、平滑性、合理性和效率成本；而 \( \omega_s \)、\( \omega_m \)、\( \omega_r \) 和 \( \omega_e \) 是各个方面的权重，表示它们在目标函数中的相对重要性。

行为规划器的目标是确定一个行动序列，使得在满足所有车辆和环境约束的前提下，最小化该目标函数。

### **B. 安全成本 (Cs)**

安全成本 \( C_{\text{Collision}} \) 被重新定义为根据车辆边界框之间的最小距离评估碰撞风险。该成本是通过以下的 Sigmoid 函数计算的：

\[
C_s = 1 - \frac{1}{1 + e^{-k_s(d_{\text{box}} - d_{\text{safe}})}}
\]

其中，\( d_{\text{box}} \) 代表自动驾驶车辆与最近障碍物之间的欧几里得距离，表示潜在碰撞风险的接近度。\( k_s \) 是控制 Sigmoid 函数斜率的正参数，较高的 \( k_s \) 值会使得在安全距离 \( d_{\text{safe}} \) 附近的变化更为陡峭。\( d_{\text{safe}} \) 是预设的安全阈值，表示希望与障碍物保持的最小安全距离，以确保安全。

此成本函数具有两个关键特性：  
- 当 \( d_{\text{box}} \geq d_{\text{safe}} \) 时，\( C_{\text{Collision}} \) 趋近于 0，表示低碰撞风险，因此安全成本较低。  
- 相反，当 \( d_{\text{box}} \) 小于 \( d_{\text{safe}} \) 时，\( C_{\text{Collision}} \) 会迅速增大，接近 1，表示高碰撞风险，从而安全成本较高。

这一公式提供了碰撞风险的动态评估，有效将车辆与障碍物之间的空间关系集成到自动驾驶车辆的行为规划模块中。

### **C. 平滑性成本 (Cm)**

平滑性成本分为横向和平纵向两个部分，全面描述了车辆运动的质量。

1. **横向平滑性**：横向平滑性旨在保持轨迹的曲率一致且最小，以确保机动的舒适性。与曲率相关的成本 \( C_\kappa \) 计算如下：

\[
C_\kappa = \omega_1 \sum_{t=0}^{T} \left( \gamma'_t \kappa(t) \right)^2 + \omega_2 \sum_{t=0}^{T} \left( \frac{d\kappa(t)}{dt} \right)^2
\]

其中，\( \kappa(t) \) 表示时间 \( t \) 时刻的曲率，\( \frac{d\kappa(t)}{dt} \) 是曲率变化率，\( \omega_1 \) 和 \( \omega_2 \) 是权重系数，用于调节曲率大小和变化率的影响，\( \gamma'_t \) 是调整每项的调节因子。

此外，还会考虑转向角（前轮角度）的变化率来影响横向平滑性，这通过 \( C_\delta \) 来表示，旨在减少转向调整的变化：

\[
C_\delta = \sum_{t=0}^{T} \left( \gamma_t \frac{d\delta(t)}{dt} \right)^2
\]

其中，\( \delta(t) \) 是时间 \( t \) 时刻的转向角，\( \gamma_t \) 用于调节时间上的成本重要性。

2. **纵向平滑性**：纵向平滑性关注的是最小化加速度的变化率（俗称“jerk”），以避免乘客的不适。加速度变化率的成本 \( C_{\text{jerk}} \) 计算为：

\[
C_{\text{jerk}} = k \sum_{t=0}^{T} \left( \gamma_i \cdot j(t)^2 \right)
\]

其中，\( j(t) \) 代表时间 \( t \) 时刻的 jerk，\( k \) 是一个系数，反映了最小化 jerk 对乘客舒适度的重要性。

这些平滑性成本组成部分确保了车辆的横向和纵向运动能共同优化，减少方向和加速度的突变，从而提供一个更加舒适的驾驶体验。

### **D. 效率成本 (Ce)**

自动驾驶中的效率至关重要，重点是优先选择能够最小化行驶时间或最大化纵向进展的轨迹。这个目标可以通过两种替代形式来表达，分别是最大化平均速度或最终纵向位置。

第一种替代形式强调最大化平均速度，通过以下成本函数计算：

\[
C_{\text{eff}} = \frac{1}{1 + e^{-k(v_{\text{avg}} - v_{\text{target}})}}
\]

其中，\( v_{\text{avg}} \) 代表车辆在整个轨迹上的平均速度，\( v_{\text{target}} \) 是目标速度，\( k \) 是一个正的比例因子。这个函数赋予超过目标速度的较低成本，从而促进效率。

第二种替代形式聚焦于最大化车辆行驶的纵向距离，旨在在给定的时间内达到或超越目标距离 \( x_{\text{target}} \)。对应的成本函数为：

\[
C_{\text{distance}} = \frac{1}{1 + e^{-k(x(T) - x_{\text{target}})}}
\]

其中，\( x(T) \) 代表车辆在规划时间结束时的纵向位置，而 \( x_{\text{target}} \) 是目标位置。这种方法激励车辆行驶更长的距离，奖励那些能将车辆推进到更接近目标的轨迹。

这两种表达方式都反映了一种战略转变，旨在提升车辆效率，优先选择能够优化速度和行驶距离的解决方案，从而与自动驾驶系统的整体操作目标对齐。

---

### **E. 合理性成本 (Cr)**

为了确保合理的驾驶行为，合理性成本侧重于换道决策和与参考路径的偏离。具体成本定义如下：

1. **换道成本**：

\[
C_{\text{laneChange}} =
\begin{cases}
0 & \text{如果没有换道} \\
C_{\text{lc}} & \text{如果在时间 } t \text{ 换道}
\end{cases}
\]

该成本函数对不必要的换道进行惩罚，尤其是在交叉口内，以促进车辆轨迹的稳定性和安全性。

2. **偏离成本**：

\[
C_{\text{deviation}} = \frac{1}{1 + e^{-k(|y(t) - y_{\text{ref}}| - d_{\text{max}})}}
\]

其中，\( |y(t) - y_{\text{ref}}| \) 代表车辆在时间 \( t \) 时刻相对于参考路径的横向偏离，\( d_{\text{max}} \) 是允许的最大偏离。该成本函数鼓励车辆保持接近参考路径，对于超出最大允许偏离的情况进行惩罚，从而指导车辆保持接近预定的路线。


